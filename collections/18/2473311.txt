On 23 May 1804, Iran demanded withdrawal from the regions Russia had occupied from Iran, comprising what is now Georgia, Dagestan, and parts of Azerbaijan. Russia refused, stormed Ganja, and declared war. Following an almost ten year stalemate centred around what is now Dagestan, east Georgia, Azerbaijan, northern Armenia, with neither party being able to gain the clear upper hand, Russia eventually managed to turn the tide. After a series of successful offensives led by General Pyotr Kotlyarevsky, including a decisive victory in the storming of Lankaran, Persia was forced to sue for peace. On October 1813, the Treaty of Gulistan, negotiated with British mediation and signed at Gulistan, made the Persian Shah Fath Ali Shah cede all Persian territories in the North Caucasus and most of its territories in the South Caucasus to Russia. This included what is now Dagestan, Georgia, and most of Azerbaijan. It also began a large demographic shift in the Caucasus, as many Muslim families emigrated to Iran.[30]